# <%= @instance %> Upstart script
# Generated by Chef for <%= @fqdn %>

description "Pushit NodeJS Application Server"

export PATH="<%= @env_path %>:$PATH"

start on (local-filesystems and runlevel [2345])
stop on runlevel [06]

respawn
console log

setuid <%= @user %>
setgid <%= @group %>

chdir <%= @app_path %>

<% @env.each do |key, value| -%>
env <%= key %>="<%= value %>"
<% end -%>

pre-start exec <%= @exec %> <%= @script_path %> <%= @environment %> >> <%= @log_path %> 2>&1

post-stop exec kill `cat <%= @pid_file %>`
exec start-stop-daemon \
  --start \
  --chdir <%= @app_path %> \
  --chuid <%= @user %>:<%= @group %> \
  --make-pidfile --pidfile <%= @pid_path %> \
  --exec <%= @exec %> \
  -- \
  <%= @script_path %> \
  >> <%= @log_path %> 2>&1
